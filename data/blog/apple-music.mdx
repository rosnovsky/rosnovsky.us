---
title: "Listening now: Apple Music"
publishedAt: "2021-10-29"
summary: "At the bottom of this page you can find the latest song I've listened to on Apple Music. Here's how I made it works."
---

Apple Music is my primary music service. I do listen to Spotify every now and again (their recomendation engine is unmatched), but being an Apple household, it makes sense to mostly use Apple Music. 

When I started working on this blog, I took a lot of inspiration from Lee Robinson. He has this little Spotify widget displaying the current song, and while it was easy to adapt and use it, it was not what I wanted. What I wanted was a widget displaying the last song I listened to on Apple Music. Which, apparently, is not trivial.

## Apple Music API

For the longest time I couldn't find a way to use Apple's MusicKit or Music API on the web. Their developer documentation is pretty poor, especially when it comes to the web stuff. At last, I figured that I'm looking for the user listening history, and there's an API endpoint for that.

This endpoint requires two different authorization tokens: `Developer token` & `user music token`. With the `Developer token`, one could query and perform actions within the Music store. And with the `user music token`, one could query and perform actions within the user's music library. So, how do you get those?

## Getting tokens

Now, the deal with the two tokens is that they are totally different, unrelated, yet somewhat connected: You need _both_ in order to fetch music history.

The developer token is a JWT that you build yourself, and sign with a private key you get at the Apple deloper portal. :qqq[More on this here](https://developer.apple.com/documentation/applemusicapi/getting_keys_and_creating_tokens).

The user music token appears to be some kind of opaque token, which you can only get after a user explicitly logs into their Apple Music account and grants your app access to their Apple Music account. So far, I was unable to find a way to generate or obtain this token programmatically. What's worse, this token expires after 6 months (fixed) and there's no way to renew it.

This last bit matters because in this whole equasion, you can generate the developer token yourself. You can obtain the user music token. But from here, you cannot update the user token, so in 6 months you'll *have to* generate a new one, in the browser, by logging in, manually, as some sort of animal.

FInally, it's a quest to figure out _how_ to get this user token, and crappy docs don't really help. Here's how you do it:

- Scaffold an HTML page with a `<script>` tag pointing to the MusicKit script
- Add "Sign in with Apple" button to the page (here's how)
- Deploy the app (to Vercel or Netlify, or wherever, otherwise you'd have to work around a bunch of issues)
- Login on this newly deployed page, grant it access to your Apple Music account
- Open Developer Tools, and in "Storage" section find the token OR add `<script>console.log(response)</script>` to the page and just copy the token from console

Not very intuitive, but it works. Now you have 6 months to use this token, and after that you'd need to do the same thing again.

As for the Developer token, I used Auth0's `jsonwebtoken` library. It allows you to both sign and verify JWT tokens. I store my private and public keys in environment variables, and sign the token like this:

```typescript
import jwt from 'jsonwebtoken'

const generateToken = async () => {
  const privateKey = process.env.PRIVATE_KEY
  const teamId = process.env.TEAM_ID
  const keyId = process.env.KEY_ID

  const token = jwt.sign({}, privateKey, {
    algorithm: 'ES256',
    expiresIn: '6 months',
    issuer: teamId,
    keyId,
  })
  return token
}
```

That's about it. Now, that you've got both tokens, everything else is pretty straightforward.

## Music API


